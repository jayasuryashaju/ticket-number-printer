<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico">
    <link rel="apple-touch-icon" href="/static/images/logo.png">
    
    <title>Jayasurya Lotteries</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Manjari:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ... (KEEP YOUR EXISTING CSS EXACTLY AS IT WAS) ... */
        :root {
            --primary: #2563eb;
            --primary-gradient: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            --accent-bg: #f8fafc;
            --card-bg: #ffffff;
            --input-bg: #f1f5f9;
            --text-main: #0f172a;
            --text-sub: #64748b;
            --danger: #ef4444;
            --radius-input: 12px;
            --radius-card: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', 'Manjari', sans-serif;
            background-color: var(--accent-bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 120px;
        }

        /* --- Header --- */
        .app-header {
            padding: 20px 20px 10px 20px;
            background: rgba(248, 250, 252, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            backdrop-filter: blur(8px);
        }

        .header-title { display: flex; align-items: center; gap: 10px; }
        
        /* App Logo in Header */
        .header-logo {
            width: 32px; height: 32px; border-radius: 8px;
        }

        .header-title h1 { 
            font-size: 20px; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: var(--text-main);
        }

        .header-actions { display: flex; gap: 8px; align-items: center; }

        .lang-btn {
            background: #e2e8f0; border: none; padding: 6px 12px; border-radius: 20px;
            font-size: 13px; font-weight: 700; color: #475569; cursor: pointer; transition: all 0.2s;
        }
        .lang-btn:active { transform: scale(0.95); }

        .icon-btn {
            background: #e2e8f0; border: none; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; color: #475569;
            cursor: pointer; transition: all 0.2s;
        }
        .reset-btn { background: #fee2e2; color: var(--danger); }
        
        /* NEW: Install Button (Hidden by default) */
        #installBtn { display: none; background: #dbeafe; color: var(--primary); }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* ... (KEEP REST OF YOUR CSS: error-banner, series-card, etc.) ... */
        .error-banner { background-color: #fef2f2; border: 1px solid #fee2e2; color: var(--danger); padding: 12px; border-radius: 12px; margin: 0 20px 20px; font-size: 14px; font-weight: 600; display: none; text-align: center; }
        .series-card { background: var(--card-bg); border-radius: var(--radius-card); padding: 24px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); margin-bottom: 24px; position: relative; border: 2px solid transparent; transition: all 0.3s ease; }
        .series-card.card-error { border-color: var(--danger); box-shadow: 0 4px 20px rgba(239, 68, 68, 0.15); }
        .btn-remove { position: absolute; top: 16px; right: 16px; background: transparent; color: var(--text-sub); border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 10px; margin-bottom: 24px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-sub); margin-bottom: 6px; }
        .input-wrapper { background: var(--input-bg); border-radius: var(--radius-input); padding: 4px 12px; border: 2px solid transparent; display: flex; align-items: center; }
        .input-wrapper:focus-within { background: #ffffff; border-color: var(--primary); }
        .input-wrapper.field-error { border-color: var(--danger); background-color: #fff5f5; }
        .input-wrapper input { width: 100%; padding: 10px 0; border: none; background: transparent; font-size: 18px; font-weight: 600; color: var(--text-main); outline: none; font-family: 'Inter', sans-serif; }
        .field-error-msg { color: var(--danger); font-size: 11px; font-weight: 600; margin-top: 4px; display: none; }
        .field-error + .field-error-msg { display: block; }
        .color-section { margin-top: 24px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { font-size: 13px; font-weight: 600; }
        .color-name-badge { font-size: 12px; font-weight: 500; color: var(--text-sub); background: var(--input-bg); padding: 2px 8px; border-radius: 6px; }
        .swatch-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 4px; scrollbar-width: none; }
        .swatch { width: 44px; height: 44px; border-radius: 50%; flex-shrink: 0; cursor: pointer; border: 2px solid rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .swatch.active { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.15); border: 2px solid white; }
        .swatch::after { content: ''; width: 14px; height: 14px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; opacity: 0; }
        .swatch.active::after { opacity: 1; }
        .swatch.none-swatch { background: #ffffff; border: 2px solid #cbd5e1; }
        .swatch.none-swatch::after { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E"); }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); padding: 16px 20px 30px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 12px; z-index: 100; }
        .btn { border: none; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; padding: 16px; flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Inter', sans-serif; }
        .btn-secondary { background: #eff6ff; color: var(--primary); }
        .btn-primary { background: var(--primary-gradient); color: white; flex: 2; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(4px); }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 320px; padding: 24px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: scale(0.9); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        .modal-overlay.open .modal-box { transform: scale(1); }
        .modal-title { font-size: 18px; font-weight: 700; color: #1e293b; margin-bottom: 8px; }
        .modal-desc { font-size: 14px; color: #64748b; margin-bottom: 24px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 12px; font-weight: 600; border: none; cursor: pointer; }
        .modal-cancel { background: #f1f5f9; color: #475569; }
        .modal-confirm { background: #ef4444; color: white; }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-title">
            <img src="/static/images/logo.png" alt="JL" class="header-logo">
            <h1 data-key="app_title">Ticket Generator</h1>
        </div>
        <div class="header-actions">
            <button id="installBtn" class="icon-btn" onclick="installApp()" title="Install App">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            </button>
            
            <button class="lang-btn" onclick="toggleLanguage()">മലയാളം</button>
            <button class="icon-btn reset-btn" onclick="openResetModal()" title="Reset All">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
        </div>
    </header>

    <div id="globalError" class="error-banner"></div>
    {% if error %}
    <div class="error-banner" style="display: block;">{{ error }}</div>
    {% endif %}

    <div class="container">
        <form method="POST" id="mainForm" novalidate>
            <div id="cards-container"></div>
        </form>
    </div>

    <div class="bottom-bar">
        <button type="button" class="btn btn-secondary" onclick="addSeries()">
            <span data-key="btn_add">+ Add Series</span>
        </button>
        <button type="button" class="btn btn-primary" onclick="submitForm()">
            <span data-key="btn_generate">Print</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
        </button>
    </div>

    <div id="resetModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title" data-key="reset_title">Clear All Data?</div>
            <div class="modal-desc" data-key="reset_desc">This will remove all series you have entered. This action cannot be undone.</div>
            <div class="modal-actions">
                <button class="modal-btn modal-cancel" onclick="closeResetModal()" data-key="cancel">Cancel</button>
                <button class="modal-btn modal-confirm" onclick="confirmReset()" data-key="yes_reset">Yes, Clear</button>
            </div>
        </div>
    </div>

    <template id="card-template">
        <div class="series-card">
            <button type="button" class="btn-remove" onclick="removeCard(this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            <div class="input-row">
                <div class="input-group">
                    <label data-key="lbl_start">Start Number</label>
                    <div class="input-wrapper">
                        <input type="tel" name="start_num[]" placeholder="1000" maxlength="4" oninput="cleanInput(this)" required>
                    </div>
                    <div class="field-error-msg" data-key="err_req">Required (4 digits)</div>
                </div>
                <div class="input-group">
                    <label data-key="lbl_end">End Number</label>
                    <div class="input-wrapper">
                        <input type="tel" name="end_num[]" placeholder="1050" maxlength="4" oninput="cleanInput(this)" required>
                    </div>
                    <div class="field-error-msg" data-key="err_req">Required (4 digits)</div>
                </div>
            </div>
            <div class="color-section">
                <div class="section-header"><span class="section-title" data-key="lbl_color">Number Color</span><span class="color-name-badge font-name-display">Red</span></div>
                <input type="hidden" name="font_color[]" value="Red" class="font-input">
                <div class="swatch-scroll font-swatches"></div>
            </div>
            <div class="color-section">
                <div class="section-header"><span class="section-title" data-key="lbl_bg">Background & Border</span><span class="color-name-badge bg-name-display">Pink</span></div>
                <input type="hidden" name="bg_color[]" value="Pink" class="bg-input">
                <div class="swatch-scroll bg-swatches"></div>
            </div>
        </div>
    </template>

    <script>
        // --- PWA Logic ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').style.display = 'flex';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                    document.getElementById('installBtn').style.display = 'none';
                }
            }
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }

        // --- LANGUAGE DATA ---
        const LANG = {
            en: {
                app_title: "Ticket Generator",
                btn_add: "+ Add Series",
                btn_generate: "Print",
                lbl_start: "Start Number",
                lbl_end: "End Number",
                lbl_color: "Number Color",
                lbl_bg: "Background",
                reset_title: "Clear All Data?",
                reset_desc: "This will remove all series you have entered. This action cannot be undone.",
                cancel: "Cancel",
                yes_reset: "Yes, Clear",
                err_req: "Required (4 digits)",
                err_min_series: "You must have at least one series.",
                err_fix: "Please fix the errors below."
            },
            ml: {
                app_title: "ടിക്കറ്റ് ജനറേറ്റർ",
                btn_add: "+ പുതിയ സീരീസ്",
                btn_generate: "പ്രിന്റ്",
                lbl_start: "തുടങ്ങുന്ന നമ്പർ",
                lbl_end: "അവസാനിക്കുന്ന നമ്പർ",
                lbl_color: "നമ്പറിന്റെ നിറം",
                lbl_bg: "ബാക്ക്ഗ്രൗണ്ട് നിറം",
                reset_title: "എല്ലാം നീക്കം ചെയ്യണോ?",
                reset_desc: "ഇത് നിങ്ങൾ നൽകിയ എല്ലാ വിവരങ്ങളും മായ്ച്ചുകളയും.",
                cancel: "വേണ്ട",
                yes_reset: "നീക്കം ചെയ്യുക",
                err_req: "4 അക്കം നിർബന്ധമാണ്",
                err_min_series: "കുറഞ്ഞത് ഒരു സീരീസ് എങ്കിലും വേണം",
                err_fix: "തെറ്റുകൾ തിരുത്തുക"
            }
        };

        let currentLang = 'en';

        // --- CONFIG ---
        const COLORS = { "Red": "#ef4444", "Blue": "#3b82f6", "Green": "#22c55e", "Black": "#0f172a", "Pink": "#e86bcf", "Orange": "#f97316", "Purple": "#a855f7", "Teal": "#14b8a6", "Navy": "#1e3a8a", "Maroon": "#7f1d1d" };
        const BG_COLORS = { "None": "#ffffff", ...COLORS };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('appLang');
            if(savedLang) {
                currentLang = savedLang;
                updateLanguageUI();
            }
            loadFromStorage();
        });

        // --- LOGIC ---
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ml' : 'en';
            localStorage.setItem('appLang', currentLang);
            updateLanguageUI();
        }

        function updateLanguageUI() {
            const langBtn = document.querySelector('.lang-btn');
            langBtn.textContent = currentLang === 'en' ? 'മലയാളം' : 'English';
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(LANG[currentLang][key]) el.textContent = LANG[currentLang][key];
            });
        }
        
        function getText(key) { return LANG[currentLang][key]; }

        function openResetModal() { document.getElementById('resetModal').classList.add('open'); }
        function closeResetModal() { document.getElementById('resetModal').classList.remove('open'); }
        function confirmReset() { localStorage.removeItem('lotteryData'); location.reload(); }

        function cleanInput(input) {
            input.value = input.value.replace(/[^0-9]/g, '');
            input.parentElement.classList.remove('field-error');
            document.getElementById('globalError').style.display = 'none';
        }

        function addSeries(data = null) {
            const container = document.getElementById('cards-container');
            const template = document.getElementById('card-template');
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.series-card');

            const defaultFont = data ? data.font : 'Red';
            const defaultBg = data ? data.bg : 'Pink';

            if(data) {
                card.querySelector('input[name="start_num[]"]').value = data.start;
                card.querySelector('input[name="end_num[]"]').value = data.end;
            }

            setupSwatches(card, 'font', COLORS, defaultFont);
            setupSwatches(card, 'bg', BG_COLORS, defaultBg);
            updateLanguageUIForNode(card);
            container.appendChild(clone);
            
            if(!data) {
                setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            }
        }

        function updateLanguageUIForNode(node) {
            node.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(LANG[currentLang][key]) el.textContent = LANG[currentLang][key];
            });
        }

        function removeCard(btn) {
            const container = document.getElementById('cards-container');
            if(container.children.length > 1) {
                const card = btn.closest('.series-card');
                card.style.opacity = '0';
                setTimeout(() => { card.remove(); saveToStorage(); }, 300);
            } else {
                showError(getText('err_min_series'));
            }
        }

        function setupSwatches(card, type, colorMap, defaultVal) {
            const container = card.querySelector(`.${type}-swatches`);
            const hiddenInput = card.querySelector(`.${type}-input`);
            const labelDisplay = card.querySelector(`.${type}-name-display`);
            
            hiddenInput.value = defaultVal;
            labelDisplay.innerText = defaultVal;

            Object.keys(colorMap).forEach(name => {
                const hex = colorMap[name];
                const swatch = document.createElement('div');
                swatch.className = 'swatch ' + (name === 'None' ? 'none-swatch' : '');
                if(name !== 'None') swatch.style.backgroundColor = hex;
                if(name === defaultVal) swatch.classList.add('active');

                swatch.onclick = () => {
                    container.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
                    swatch.classList.add('active');
                    hiddenInput.value = name;
                    labelDisplay.innerText = name;
                };
                container.appendChild(swatch);
            });
        }

        function showError(msg) {
            const banner = document.getElementById('globalError');
            banner.textContent = msg;
            banner.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function submitForm() {
            const form = document.getElementById('mainForm');
            const cards = document.querySelectorAll('.series-card');
            let isValid = true;
            let firstErrorElement = null;

            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
            document.querySelectorAll('.series-card').forEach(el => el.classList.remove('card-error'));
            document.getElementById('globalError').style.display = 'none';

            cards.forEach(card => {
                const startInput = card.querySelector('input[name="start_num[]"]');
                const endInput = card.querySelector('input[name="end_num[]"]');
                const startVal = parseInt(startInput.value);
                const endVal = parseInt(endInput.value);
                const startWrapper = startInput.parentElement;
                const endWrapper = endInput.parentElement;
                let cardHasError = false;

                if (!startInput.value || startInput.value.length !== 4) {
                    startWrapper.classList.add('field-error'); isValid = false; cardHasError = true;
                    if(!firstErrorElement) firstErrorElement = card;
                }
                if (!endInput.value || endInput.value.length !== 4) {
                    endWrapper.classList.add('field-error'); isValid = false; cardHasError = true;
                    if(!firstErrorElement) firstErrorElement = card;
                }
                if (startVal > endVal) {
                    startWrapper.classList.add('field-error'); endWrapper.classList.add('field-error');
                    isValid = false; cardHasError = true;
                    if(!firstErrorElement) firstErrorElement = card;
                }
                if(cardHasError) card.classList.add('card-error');
            });

            if (isValid) {
                saveToStorage();
                form.submit();
            } else {
                showError(getText('err_fix'));
            }
        }

        function saveToStorage() {
            const data = [];
            document.querySelectorAll('.series-card').forEach(card => {
                data.push({
                    start: card.querySelector('input[name="start_num[]"]').value,
                    end: card.querySelector('input[name="end_num[]"]').value,
                    font: card.querySelector('input[name="font_color[]"]').value,
                    bg: card.querySelector('input[name="bg_color[]"]').value
                });
            });
            localStorage.setItem('lotteryData', JSON.stringify(data));
        }

        function loadFromStorage() {
            const stored = localStorage.getItem('lotteryData');
            const container = document.getElementById('cards-container');
            if (stored) {
                const data = JSON.parse(stored);
                if(data.length > 0) {
                    container.innerHTML = '';
                    data.forEach(item => addSeries(item));
                    return;
                }
            }
            addSeries();
        }
    </script>
</body>
</html>